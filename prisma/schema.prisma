// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ServiceType {
  INSTALLATION
  NETWORKING
  DIGITAL_MARKETING
  MAINTENANCE
  CONSULTATION
  DEMO
  REPAIR
  UPGRADE
  AUDIT
  TRAINING
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OfferCategory {
  CCTV
  DIGITAL_MARKETING
}

enum QuotationStatus {
  DRAFT
  SAVED
  PURCHASED
  BOOKED_INSTALLATION
  COMPLETED
  CANCELLED
}

enum QuotationSource {
  HOME_CALCULATOR
  GET_QUOTATION_PAGE
  DIRECT_PURCHASE
  BOOK_INSTALLATION
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Hashed password for credentials provider
  role          UserRole  @default(USER)
  phone         String?
  phoneVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts  Account[]
  sessions  Session[]
  orders    Order[]
  bookings  Booking[]
  addresses Address[]
  cart      CartItem[]
  aiConversations AIConversation[]
  quotations Quotation[]
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Brand {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String   @unique
  slug               String   @unique
  description        String?
  logo               String?
  active             Boolean  @default(true)
  enableForQuotation Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  products Product[]
}

model Category {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String   @unique
  slug               String   @unique
  description        String?
  icon               String?
  active             Boolean  @default(true)
  enableForQuotation Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  subCategories                        SubCategory[]
  products                             Product[]
  territoryCategoryCategories          TerritoryCategoryCategory[]
  quotationHddSettings                 QuotationHddSetting[]
  quotationWirings                     QuotationWiring[]
  quotationInstallations               QuotationInstallation[]
  quotationRecordingDeviceSettings     QuotationRecordingDeviceSetting[] @relation("RecordingDeviceCategory")
  recordingDeviceCameraTypes           QuotationRecordingDeviceSetting[] @relation("RecordingDeviceCameraType")
  quotationPowerSupplySettings         QuotationPowerSupplySetting[] @relation("PowerSupplyCategory")
  powerSupplyCameraTypes               QuotationPowerSupplySetting[] @relation("PowerSupplyCameraType")
  accessoriesCameraTypes               QuotationAccessoriesSetting[] @relation("AccessoriesCameraType")
  bitrateCameraTypes                   QuotationBitrateSetting[] @relation("BitrateCameraType")
}

model SubCategory {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String
  slug               String
  description        String?
  icon               String?
  categoryId         String   @db.ObjectId
  active             Boolean  @default(true)
  enableForQuotation Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  category                       Category                       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products                       Product[]
  territoryCategorySubCategories TerritoryCategorySubCategory[]
  quotationHddSettings           QuotationHddSetting[]
  quotationRecordingDeviceSettings QuotationRecordingDeviceSetting[]
  quotationPowerSupplySettings   QuotationPowerSupplySetting[]

  @@unique([slug, categoryId])
  @@index([categoryId])
}

model TerritoryCategory {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String   @unique
  slug               String   @unique
  description        String?
  active             Boolean  @default(true)
  enableForQuotation Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  categories    TerritoryCategoryCategory[]
  subCategories TerritoryCategorySubCategory[]
  products      Product[]
  quotationHddSettingTerritoryCategories QuotationHddSettingTerritoryCategory[]
  quotationRecordingDeviceSettingTerritoryCategories QuotationRecordingDeviceSettingTerritoryCategory[]
  quotationPowerSupplySettingTerritoryCategories QuotationPowerSupplySettingTerritoryCategory[]
  quotationBitrateSettingTerritoryCategories QuotationBitrateSettingTerritoryCategory[]
}

model TerritoryCategoryCategory {
  id                  String @id @default(auto()) @map("_id") @db.ObjectId
  territoryCategoryId String @db.ObjectId
  categoryId          String @db.ObjectId

  territoryCategory TerritoryCategory @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)
  category          Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([territoryCategoryId, categoryId])
  @@index([territoryCategoryId])
  @@index([categoryId])
}

model TerritoryCategorySubCategory {
  id                  String @id @default(auto()) @map("_id") @db.ObjectId
  territoryCategoryId String @db.ObjectId
  subCategoryId       String @db.ObjectId

  territoryCategory TerritoryCategory @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)
  subCategory       SubCategory       @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  @@unique([territoryCategoryId, subCategoryId])
  @@index([territoryCategoryId])
  @@index([subCategoryId])
}

model Product {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String
  slug               String   @unique
  description        String
  price              Float
  comparePrice       Float?
  sku                String?  @unique
  stock              Int      @default(0)
  images             String[]
  category           String // Keep for backward compatibility
  tags               String[]
  featured           Boolean  @default(false)
  active             Boolean  @default(true)
  enableForQuotation Boolean  @default(true)
  specifications     Json?
  originalResolutionSupport String[] // Array of territory category IDs for Original/True Resolution Support
  compatibleResolutionSupport String[] // Array of territory category IDs for Compatible/Supported Resolution
  maxCameraSupport    Int?     // Maximum number of camera support (for Recording Device products)
  megapixelSupported  String[] // Array of territory category IDs for Megapixel Supported (for Power Supply products)
  maxCameraSupported  Int?     // Maximum number of camera supported (for Power Supply products)
  maxWireInMeter      Float?   // Maximum wire length in meters (for Power Supply products)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // New relationships
  brandId             String? @db.ObjectId
  categoryId          String? @db.ObjectId
  subCategoryId       String? @db.ObjectId
  territoryCategoryId String? @db.ObjectId

  brand             Brand?             @relation(fields: [brandId], references: [id], onDelete: SetNull)
  categoryRelation  Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subCategory       SubCategory?       @relation(fields: [subCategoryId], references: [id], onDelete: SetNull)
  territoryCategory TerritoryCategory? @relation(fields: [territoryCategoryId], references: [id], onDelete: SetNull)

  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([brandId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([territoryCategoryId])
}

model CartItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model Address {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  country      String   @default("India")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

model Order {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber       String        @unique
  userId            String        @db.ObjectId
  addressId         String        @db.ObjectId
  total             Float
  subtotal          Float
  tax               Float         @default(0)
  shipping          Float         @default(0)
  status            OrderStatus   @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  items   OrderItem[]
}

model OrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int
  price     Float
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model Booking {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingNumber String        @unique
  userId        String        @db.ObjectId
  serviceType   ServiceType
  description   String
  address       String
  city          String
  state         String
  pincode       String
  phone         String
  email         String
  status        BookingStatus @default(PENDING)
  priority      String?       @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  scheduledAt   DateTime?
  completedAt   DateTime?
  assignedTo   String?       // Staff/Admin user ID
  notes         String?       // Admin notes
  customerNotes String?       // Customer notes
  quotationId   String?       @db.ObjectId // Link to quotation if applicable
  estimatedDuration Int?      // Estimated duration in hours
  estimatedCost Float?        // Estimated cost
  actualCost   Float?         // Actual cost after completion
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
  
  @@index([status])
  @@index([serviceType])
  @@index([scheduledAt])
  @@index([userId])
}

model PriceCalculation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  cameraCount Int
  cameraType  String
  storage     String
  features    Json
  totalPrice  Float
  createdAt   DateTime @default(now())
}

model Settings {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  siteName          String   @default("D.G.Yard")
  siteTagline       String?
  logo              String?
  favicon           String?  // Main favicon (fallback)
  favicon16x16      String?  // 16x16 favicon
  favicon32x32      String?  // 32x32 favicon
  favicon192x192    String?  // 192x192 PWA icon
  favicon512x512    String?  // 512x512 PWA icon
  appleTouchIcon    String?  // 180x180 Apple touch icon
  description       String?
  keywords          String?
  
  // Contact Information
  email             String?
  phone             String?
  whatsappNumber    String?
  address           String?
  city              String?
  state             String?
  pincode           String?
  country           String?  @default("India")
  
  // Social Media
  facebookUrl       String?
  twitterUrl        String?
  instagramUrl      String?
  linkedinUrl       String?
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  
  // AI Voice Settings
  aiVoiceName       String?  // Selected voice name (e.g., "Microsoft Zira", "Google Neural")
  aiVoiceLang       String?  @default("en-IN") // Voice language (en-IN, hi-IN)
  aiVoiceRate       Float?   @default(1.0) // Speech rate (0.1 to 10, default 1.0)
  aiVoicePitch      Float?   @default(1.0) // Speech pitch (0 to 2, default 1.0)
  aiVoiceVolume     Float?   @default(1.0) // Speech volume (0 to 1, default 1.0)
  aiVoiceURI        String?  // Voice URI for custom voices
  aiCustomVoiceUrl  String?  // URL for custom recorded voice (if uploaded)
  aiVoiceScript     String?  // Script for voice recording (what to say)
  
  // Google My Business OAuth
  gmbAccessToken    String?  // Google My Business OAuth access token
  gmbRefreshToken   String?  // Google My Business OAuth refresh token
  gmbTokenExpiry    DateTime? // Token expiry time
  gmbLocationId     String?  // Google My Business location ID
  gmbAccountName    String?  // GMB account name
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PageContent {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  pageSlug          String   @unique // e.g., "security-surveillance"
  content           Json     // Full page content as JSON
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Quotation Settings Models
model QuotationHddSetting {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId        String   @db.ObjectId
  subCategoryId     String   @db.ObjectId
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  category          Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subCategory       SubCategory       @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  territoryCategories QuotationHddSettingTerritoryCategory[]
}

model QuotationHddSettingTerritoryCategory {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  quotationHddSettingId   String   @db.ObjectId
  territoryCategoryId     String   @db.ObjectId
  capacityGB              Float?   // Capacity in GB
  capacityTB              Float?   // Capacity in TB
  createdAt               DateTime @default(now())

  quotationHddSetting     QuotationHddSetting @relation(fields: [quotationHddSettingId], references: [id], onDelete: Cascade)
  territoryCategory       TerritoryCategory   @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)

  @@unique([quotationHddSettingId, territoryCategoryId])
  @@index([quotationHddSettingId])
  @@index([territoryCategoryId])
}

model QuotationWiring {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId          String   @db.ObjectId
  cableName           String   // e.g., Cat6, Coaxial, etc.
  pricePerMeter       Float    // Total: wirePricePerMeter + wiringChargePerMeter (for backward compatibility)
  wirePricePerMeter   Float?   // Wire price per meter
  wiringChargePerMeter Float?  // Wiring charge per meter
  shortDetail         String?
  active              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model QuotationInstallation {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId        String   @db.ObjectId
  maxCableLength    Float    @default(90) // Maximum cable length in meters
  ratePerCamera     Float    // Rate per camera
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  category          Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model QuotationRecordingDeviceSetting {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  cameraTypeId      String?  @db.ObjectId // Camera Type (enableForQuotation categories)
  categoryId        String   @db.ObjectId
  subCategoryId     String   @db.ObjectId
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cameraType        Category? @relation("RecordingDeviceCameraType", fields: [cameraTypeId], references: [id], onDelete: SetNull)
  category          Category  @relation("RecordingDeviceCategory", fields: [categoryId], references: [id], onDelete: Cascade)
  subCategory       SubCategory       @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  territoryCategories QuotationRecordingDeviceSettingTerritoryCategory[]
}

model QuotationRecordingDeviceSettingTerritoryCategory {
  id                              String   @id @default(auto()) @map("_id") @db.ObjectId
  quotationRecordingDeviceSettingId   String   @db.ObjectId
  territoryCategoryId             String   @db.ObjectId
  createdAt                       DateTime @default(now())

  quotationRecordingDeviceSetting QuotationRecordingDeviceSetting @relation(fields: [quotationRecordingDeviceSettingId], references: [id], onDelete: Cascade)
  territoryCategory               TerritoryCategory   @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)

  @@unique([quotationRecordingDeviceSettingId, territoryCategoryId])
  @@index([quotationRecordingDeviceSettingId])
  @@index([territoryCategoryId])
}

model QuotationPowerSupplySetting {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  cameraTypeId      String?  @db.ObjectId // Camera Type (enableForQuotation categories)
  categoryId        String   @db.ObjectId
  subCategoryId     String?  @db.ObjectId
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cameraType        Category? @relation("PowerSupplyCameraType", fields: [cameraTypeId], references: [id], onDelete: SetNull)
  category          Category  @relation("PowerSupplyCategory", fields: [categoryId], references: [id], onDelete: Cascade)
  subCategory       SubCategory?       @relation(fields: [subCategoryId], references: [id], onDelete: SetNull)
  territoryCategories QuotationPowerSupplySettingTerritoryCategory[]
}

model QuotationPowerSupplySettingTerritoryCategory {
  id                              String   @id @default(auto()) @map("_id") @db.ObjectId
  quotationPowerSupplySettingId   String   @db.ObjectId
  territoryCategoryId             String   @db.ObjectId
  createdAt                       DateTime @default(now())

  quotationPowerSupplySetting QuotationPowerSupplySetting @relation(fields: [quotationPowerSupplySettingId], references: [id], onDelete: Cascade)
  territoryCategory               TerritoryCategory   @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)

  @@unique([quotationPowerSupplySettingId, territoryCategoryId])
  @@index([quotationPowerSupplySettingId])
  @@index([territoryCategoryId])
}

model QuotationAccessoriesSetting {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  cameraTypeId      String   @db.ObjectId // Camera Type (enableForQuotation categories) - mandatory
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cameraType        Category @relation("AccessoriesCameraType", fields: [cameraTypeId], references: [id], onDelete: Cascade)
  items             QuotationAccessoriesItem[]
}

model QuotationAccessoriesItem {
  id                              String   @id @default(auto()) @map("_id") @db.ObjectId
  quotationAccessoriesSettingId   String   @db.ObjectId
  itemName                        String   // Mandatory
  quantity                        Int      // Mandatory
  rate                            Float    // Mandatory
  isCableLengthBased              Boolean  @default(false) // If true, this item is based on cable length
  maxCableInMeter                  Float?   // Maximum cable length in meters (for cable-length based items)
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  quotationAccessoriesSetting QuotationAccessoriesSetting @relation(fields: [quotationAccessoriesSettingId], references: [id], onDelete: Cascade)

  @@index([quotationAccessoriesSettingId])
}

model QuotationBitrateSetting {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  cameraTypeId      String   @db.ObjectId // Camera Type (enableForQuotation categories) - mandatory
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cameraType        Category @relation("BitrateCameraType", fields: [cameraTypeId], references: [id], onDelete: Cascade)
  territoryCategories QuotationBitrateSettingTerritoryCategory[]
}

model QuotationBitrateSettingTerritoryCategory {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  quotationBitrateSettingId String   @db.ObjectId
  territoryCategoryId     String   @db.ObjectId
  bitrate                Float    // Bitrate in kbps
  createdAt               DateTime @default(now())

  quotationBitrateSetting QuotationBitrateSetting @relation(fields: [quotationBitrateSettingId], references: [id], onDelete: Cascade)
  territoryCategory       TerritoryCategory   @relation(fields: [territoryCategoryId], references: [id], onDelete: Cascade)

  @@unique([quotationBitrateSettingId, territoryCategoryId])
  @@index([quotationBitrateSettingId])
  @@index([territoryCategoryId])
}

// AI Learning System Models
model AIConversation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String?  @db.ObjectId
  userRole        String   // USER, ADMIN, MODERATOR
  message         String
  response        String
  responseSource  String   // rule-based, openai, google-genai
  language        String   @default("en-IN") // en-IN, hi-IN
  context         String?  // Context used for generating response
  currentPath     String?  // Page path where conversation happened
  feedback        AIConversationFeedback?
  qualityScore    Float?   // 0-1 score based on feedback and usage
  usageCount      Int      @default(1) // How many times this pattern was used
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  knowledgeBaseEntries AIKnowledgeBase[]

  @@index([userId])
  @@index([userRole])
  @@index([qualityScore])
  @@index([createdAt])
}

model AIConversationFeedback {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String   @unique @db.ObjectId
  rating          Int      // 1-5 stars or -1 (thumbs down), 1 (thumbs up)
  feedbackType    String   // thumbs-up, thumbs-down, rating, correction
  userComment     String?  // Optional user comment
  correctedResponse String? // If user provided correction
  createdAt       DateTime @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([rating])
}

model AIKnowledgeBase {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String   @db.ObjectId
  questionPattern String   // Normalized question pattern
  answerTemplate  String   // Template or pattern for answer
  keywords        String[] // Keywords extracted from question
  category        String?  // product, service, quotation, admin, etc.
  userRole        String   // USER, ADMIN, MODERATOR
  qualityScore    Float    @default(0.5) // 0-1, starts at 0.5
  successCount    Int      @default(0) // Times this knowledge was used successfully
  failureCount    Int      @default(0) // Times this knowledge failed
  lastUsedAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([questionPattern])
  @@index([category])
  @@index([userRole])
  @@index([qualityScore])
  @@index([keywords])
}

model AILearningPattern {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  patternType     String   // question-pattern, response-template, context-rule
  pattern         String   // The actual pattern
  example         String   // Example usage
  category        String?  // product, service, quotation, etc.
  userRole        String   // USER, ADMIN, MODERATOR
  confidence      Float    @default(0.5) // 0-1 confidence score
  usageCount      Int      @default(0)
  successRate     Float    @default(0.5) // Success rate 0-1
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([patternType])
  @@index([category])
  @@index([userRole])
  @@index([confidence])
}

model Offer {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  category    OfferCategory
  image       String?
  discount    Float?        // Discount percentage
  originalPrice Float?      // Original price (if applicable)
  offerPrice  Float?        // Offer price (if applicable)
  validFrom   DateTime?
  validUntil  DateTime?
  active      Boolean       @default(true)
  featured    Boolean       @default(false)
  order       Int           @default(0) // For ordering offers
  ctaText     String?       // Call to action text (e.g., "Get Offer", "Book Now")
  ctaLink     String?       // Call to action link
  createdAt   DateTime      @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([category])
  @@index([active])
  @@index([featured])
  @@index([order])
}

model Quotation {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  quotationNumber   String           @unique
  userId            String?          @db.ObjectId
  source            QuotationSource
  status            QuotationStatus  @default(SAVED)
  
  // Form Data
  brandId           String?
  brandName         String?
  cameraTypeId      String?
  cameraTypeName    String?
  resolutionId      String?
  resolutionName    String?
  indoorCameraCount Int?            @default(0)
  outdoorCameraCount Int?           @default(0)
  wiringMeters      Float?          @default(0)
  hddId             String?
  hddName           String?
  recordingDays     Int?            @default(0)
  
  // Calculated Data
  totalPrice        Float
  subtotal          Float?
  tax               Float?           @default(0)
  installationCost  Float?          @default(0)
  wiringCost        Float?          @default(0)
  hddCost           Float?          @default(0)
  accessoriesCost   Float?          @default(0)
  powerSupplyCost   Float?          @default(0)
  recordingDeviceCost Float?        @default(0)
  
  // Additional Data (JSON for flexibility)
  calculationDetails Json?          // Full calculation breakdown
  selectedProducts   Json?          // Selected products with details
  
  // User Information (snapshot at time of quotation)
  userName          String?
  userEmail         String?
  userPhone         String?
  userAddress       String?
  
  // Related Order/Booking IDs
  orderId           String?
  bookingId         String?
  
  // Notes
  notes             String?
  
  // Button Action Tracking
  buttonAction      String?          // Which button was pressed (DOWNLOAD, SHARE, CONTACT_SELLER, BOOK_INSTALLATION, SHOW_SUGGESTIONS, etc.)
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([source])
  @@index([createdAt])
}

model Review {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  role              String?  // e.g., "Business Owner", "Homeowner"
  content           String
  rating            Int      // 1-5 stars
  image             String?  // Profile image URL
  source            String?  // "Google My Business", "Website", "Manual", etc.
  googleReviewId    String?  // Google review ID if from GMB
  verified          Boolean  @default(false) // Verified review
  featured          Boolean  @default(false) // Featured on homepage
  active            Boolean  @default(true) // Admin control to show/hide
  order             Int      @default(0) // Display order
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([active])
  @@index([featured])
  @@index([order])
  @@index([createdAt])
}

model AuditRequest {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String?  @db.ObjectId
  type              String   // "public" | "connected"
  status            String   // "pending" | "processing" | "completed" | "failed"
  websiteUrl        String?
  gbpName           String?
  gbpAddress        String?
  socialLinks       Json     // { facebook, instagram, youtube, linkedin, twitter }
  metadata          Json     // Additional data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  results           AuditResult[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AuditResult {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  auditRequestId    String   @db.ObjectId
  score             Int?     // 0-100
  report            Json     // Full audit report JSON
  pdfPath           String?  // Path to generated PDF
  createdAt         DateTime @default(now())

  auditRequest      AuditRequest @relation(fields: [auditRequestId], references: [id], onDelete: Cascade)

  @@index([auditRequestId])
  @@index([createdAt])
}

model ConnectedAccount {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @db.ObjectId
  provider          String   // "google_business", "google_analytics", "facebook", "instagram"
  tokenEnc          String   // Encrypted token
  refreshTokenEnc   String?  // Encrypted refresh token
  expiresAt         DateTime?
  scope             String?  // OAuth scopes
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([provider])
}

model Lead {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String?  @db.ObjectId // Optional - can be anonymous
  source            String   // "honey_chat", "website", "marketing_page", etc.
  type              String   // "appointment", "call", "quote", "general"
  page              String?  // Page where lead was captured
  context           String?  // Conversation context or additional info
  status            String   @default("NEW") // NEW, CONTACTED, QUALIFIED, CONVERTED
  metadata          Json?    // Additional data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([source])
  @@index([createdAt])
}
